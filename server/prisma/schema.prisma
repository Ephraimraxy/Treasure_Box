// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(cuid())
  email           String          @unique
  password        String
  name            String?
  username        String?         @unique
  transactionPin  String?         // Hashed PIN
  phone           String?
  address         String?
  bvn             String?         @unique
  nin             String?         @unique
  photoUrl        String?
  paystackCustomerCode String?
  referralCode    String          @unique @default(cuid())
  referredById    String?
  referredBy      User?           @relation("Referrals", fields: [referredById], references: [id])
  referrals       User[]          @relation("Referrals")
  referralEarnings Float          @default(0)
  kycVerified     Boolean         @default(false)
  kycStatus       KYCStatus       @default(NOT_STARTED)
  kycPhotoUrl     String?
  balance         Float           @default(0)
  role            Role            @default(USER)
  isSuspended     Boolean         @default(false)
  suspensionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Email verification
  emailVerified       Boolean   @default(false)
  verificationToken   String?
  verificationExpires DateTime?

  // Password reset
  resetToken    String?
  resetExpires  DateTime?

  // OTP
  otp           String?
  otpExpires    DateTime?

  transactions    Transaction[]
  investments     Investment[]
  notifications   Notification[]
  bankDetails     BankDetail[]
  virtualAccount  VirtualAccount?
  quizParticipations QuizParticipant[]
  researchRequests ResearchRequest[]
  notificationSettings Json?       // Deprecated? Or keep for backward compat? Prefer 'preferences' now.
  preferences     Json?           // { theme: string, notifications: { ... } }

  disputes        Dispute[]
}

model Dispute {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject       String
  message       String        @db.Text
  snapshotUrl   String?       // Local path or Base64 (if small) - likely path to /uploads/filename
  status        DisputeStatus @default(OPEN)
  adminReply    String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

enum DisputeStatus {
  OPEN
  RESOLVED
  CLOSED
}

model BankDetail {
  id            String @id @default(cuid())
  userId        String
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankName      String
  bankCode      String?
  accountNumber String
  accountName   String
}

model VirtualAccount {
  id            String @id @default(cuid())
  userId        String @unique
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankName      String
  accountNumber String
  accountName   String
}

model Transaction {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  investmentId    String?
  type            TransactionType
  amount          Float
  status          TransactionStatus @default(PENDING)
  description     String
  rejectionReason String?
  meta            Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model Investment {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  principal       Float
  durationDays    Int
  baseRate        Float
  bonusRate       Float            @default(0)
  startDate       DateTime         @default(now())
  maturityDate    DateTime
  status          InvestmentStatus @default(ACTIVE)
  payoutProcessed Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      NotificationType @default(INFO)
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
}

model Settings {
  id                        String  @id @default("global")
  paystackPublicKey         String?
  isSystemPaused            Boolean @default(false)
  withdrawalPacingThreshold Int     @default(10)
  withdrawalPacingDelay     String  @default("24 hours")
  minDeposit                Float   @default(1000)
  minWithdrawal             Float   @default(1000)
  minInvestment             Float   @default(5000)
  maxWithdrawal             Float   @default(1000000)
  autoTransferThreshold     Decimal @default(50000) @db.Decimal(18,2)
  minLiquidityRatio         Decimal @default(1.05)  @db.Decimal(5,2)
  enableNotifications       Boolean @default(true)
  enableEmailLoginAlerts    Boolean @default(true)
  enableWithdrawalApproval Boolean @default(true)
  kycRequiredForAccount     Boolean @default(true)
  defaultTheme              String  @default("dark") // system, light, dark
  showUserQuizNav           Boolean @default(true)
  showUserBoxNav            Boolean @default(true)
  enableUserAdsPopup        Boolean @default(true)
}

// ── Financial Control Center Models ────────────────────────

model SystemWallet {
  id                      Int      @id @default(1)
  userReserveBalance      Decimal  @default(0) @db.Decimal(18,2)
  profitBalance           Decimal  @default(0) @db.Decimal(18,2)
  operationalBalance      Decimal  @default(0) @db.Decimal(18,2)
  lockedInvestmentBalance Decimal  @default(0) @db.Decimal(18,2)
  updatedAt               DateTime @updatedAt
}

model ReconciliationLog {
  id                String   @id @default(cuid())
  date              DateTime @default(now())
  userLiability     Decimal  @db.Decimal(18,2)
  paystackAvailable Decimal  @db.Decimal(18,2)
  difference        Decimal  @db.Decimal(18,2)
  coverageRatio     Decimal? @db.Decimal(10,4)
  status            String   // OK, WARNING, CRITICAL
  createdAt         DateTime @default(now())
}

model PaystackBalanceSnapshot {
  id        String   @id @default(cuid())
  available Decimal  @db.Decimal(18,2)
  pending   Decimal  @db.Decimal(18,2)
  createdAt DateTime @default(now())
}

model SystemHealth {
  id                       Int       @id @default(1)
  lastWebhookAt            DateTime?
  lastSuccessfulTransferAt DateTime?
  lastFailedTransferAt     DateTime?
  lastReconciliation       DateTime?
  failedTransferCount24h   Int       @default(0)
  updatedAt                DateTime  @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  adminEmail String
  action     String
  details    String
  createdAt  DateTime @default(now())
}

// ── Quiz Economy Models ──────────────────────────────────

model QuizCourse {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  icon        String?      // emoji or icon name
  isActive    Boolean      @default(true)
  modules     QuizModule[]
  createdAt   DateTime     @default(now())
}

model QuizModule {
  id          String       @id @default(cuid())
  courseId    String
  course      QuizCourse   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isActive    Boolean      @default(true)
  levels      QuizLevel[]
  createdAt   DateTime     @default(now())
  @@unique([courseId, name])
}

model QuizLevel {
  id          String         @id @default(cuid())
  moduleId    String
  module      QuizModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  level       Int            // 1, 2, 3...
  name        String         // "Beginner", "Intermediate", "Advanced"
  questions   QuizQuestion[]
  games       QuizGame[]
  createdAt   DateTime       @default(now())
  @@unique([moduleId, level])
}

model QuizQuestion {
  id            String     @id @default(cuid())
  levelId       String
  level         QuizLevel  @relation(fields: [levelId], references: [id], onDelete: Cascade)
  question      String
  optionA       String
  optionB       String
  correctOption String     // "A" or "B"
  timeLimit     Int        @default(15) // seconds per question
  createdAt     DateTime   @default(now())
}

model QuizGame {
  id            String           @id @default(cuid())
  mode          QuizGameMode     // SOLO, DUEL, LEAGUE
  levelId       String
  level         QuizLevel        @relation(fields: [levelId], references: [id])
  entryAmount   Float
  status        QuizGameStatus   @default(WAITING)
  matchCode     String?          @unique
  maxPlayers    Int              @default(1)
  platformFee   Float            @default(0)
  prizePool     Float            @default(0)
  questionIds   Json?            // Array of question IDs for this game session
  startedAt     DateTime?
  endedAt       DateTime?
  expiresAt     DateTime?        // For DUEL/LEAGUE: auto-expire after 24hrs if still WAITING
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  participants  QuizParticipant[]
}

model QuizParticipant {
  id            String     @id @default(cuid())
  gameId        String
  game          QuizGame   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  userId        String
  user          User       @relation(fields: [userId], references: [id])
  score         Int        @default(0)
  totalTime     Float      @default(0)  // total seconds taken
  isWinner      Boolean    @default(false)
  payout        Float      @default(0)
  answers       Json?      // [{questionId, answer, correct, timeTaken}]
  completedAt   DateTime?
  createdAt     DateTime   @default(now())
  @@unique([gameId, userId])
}

enum Role {
  USER
  ADMIN
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  INVESTMENT_PAYOUT
  INVESTMENT_DEBIT
  UTILITY_BILL
  AIRTIME_DEPOSIT
  REFERRAL_BONUS
  QUIZ_ENTRY
  QUIZ_WINNING
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REJECTED
}

enum InvestmentStatus {
  ACTIVE
  MATURED
  PAYOUT_PENDING
  PAYOUT_PROCESSED
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum KYCStatus {
  NOT_STARTED
  PENDING
  VERIFIED
  REJECTED
}

enum QuizGameMode {
  SOLO
  DUEL
  LEAGUE
}

enum QuizGameStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

model ResearchRequest {
  id              String         @id @default(cuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // User Info (Snapshot)
  fullName        String
  email           String
  role            ResearchRole
  institution     String?

  // Research Details
  serviceCategory String
  specificService String
  researchLevel   String
  discipline      String
  description     String         @db.Text
  
  // Timeline
  preferredDate   DateTime?
  urgency         String         // Normal / Urgent

  // Attachments
  attachmentUrl   String?

  // Status
  status          ResearchStatus @default(PENDING)
  
  // Admin & Payout Fields
  adminNotes      String?        @db.Text
  quoteAmount     Float?         @default(0)
  isPaid          Boolean        @default(false)
  deliveryUrl     String?        // Final deliverable link

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

enum ResearchRole {
  STUDENT
  ACADEMIC
  RESEARCHER
  INSTITUTION
}

enum ResearchStatus {
  PENDING
  REVIEWING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

// ── Capital Protection ─────────────────────────────────────

model CapitalProtectionLog {
  id          String   @id @default(cuid())
  coverage    Decimal  @db.Decimal(10,4)
  threshold   Decimal  @db.Decimal(10,4)
  liability   Decimal  @db.Decimal(18,2)
  available   Decimal  @db.Decimal(18,2)
  action      String   // BLOCK_TRANSFER, ALLOW_TRANSFER
  triggeredBy String   // USER_WITHDRAWAL, ADMIN_APPROVAL
  createdAt   DateTime @default(now())
}
